<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>è‡ªå‹•è²©å£²æ©Ÿç®¡ç†</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-dark: #388E3C;
            --secondary-color: #8BC34A;
            --accent-color: #FFC107;
            --danger-color: #f44336;
            --text-color: #333;
            --bg-color: #f5f5f5;
            --locker-bg: #fff;
            --locker-empty: #e0e0e0;
            --locker-border: #ccc;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        #app {
            width: 100%;
            max-width: 600px;
            background: white;
            padding: 15px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .activity-warning {
            background: #fff3e0;
            color: #ef6c00;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            border-radius: 8px;
            border: 1px solid #ffe0b2;
            margin-bottom: 5px;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }

            100% {
                opacity: 1;
            }
        }

        .app-header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
            position: relative;
            border-bottom: 2px solid #eee;
            padding-bottom: 12px;
        }

        /* ç¸¦å‘ãå›ºå®šã®è­¦å‘Šè¡¨ç¤º */
        #orientation-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 10000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        #orientation-warning .icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: rotate-hint 2s infinite;
        }

        @keyframes rotate-hint {
            0% {
                transform: rotate(0deg);
            }

            50% {
                transform: rotate(-90deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        #orientation-warning p {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary-dark);
        }

        /* JSåˆ¶å¾¡ã«å¤‰æ›´ã™ã‚‹ãŸã‚ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒªå‰Šé™¤ */
        #orientation-warning {
            /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã¯ç¶­æŒã€è¡¨ç¤ºã¯JSã§åˆ¶å¾¡ */
        }

        .app-header h1 {
            margin: 0;
            text-align: center;
            font-size: 1.6rem;
            color: var(--primary-dark);
        }

        .mode-switch,
        .machine-switch {
            display: flex;
            background: #eee;
            padding: 4px;
            border-radius: 25px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .mode-btn,
        .machine-tab {
            flex: 1;
            min-width: 70px;
            border: none;
            background: transparent;
            padding: 12px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
            transition: all 0.2s;
            font-size: 1.1rem;
            white-space: nowrap;
        }

        .mode-btn.active,
        .machine-tab.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            color: var(--primary-color);
        }

        .mode-btn.active#mode-seller {
            color: #E91E63;
        }

        .icon-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        .sales-summary {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 2px solid var(--primary-color);
        }

        .sales-summary.hidden {
            display: none;
        }

        .copy-mode-indicator {
            margin-bottom: 15px;
        }

        .sales-summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .sales-label {
            font-size: 1rem;
            color: #666;
            font-weight: bold;
        }

        .sales-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-dark);
        }

        .bulk-purchase-area {
            margin-bottom: 15px;
        }

        .bulk-purchase-area.hidden {
            display: none;
        }

        .locker-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .locker {
            aspect-ratio: 1;
            background: var(--locker-empty);
            border: 2px solid var(--locker-border);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.1s;
            user-select: none;
            position: relative;
            min-height: 90px;
        }

        .locker:active {
            transform: scale(0.95);
        }

        .locker.locked {
            background: #E8F5E9;
            border-color: var(--primary-color);
        }

        .locker-id {
            position: absolute;
            top: 4px;
            left: 4px;
            font-size: 0.95rem;
            font-weight: bold;
            color: #666;
        }

        .locker-product {
            font-weight: bold;
            font-size: 1.15rem;
            margin-bottom: 4px;
            text-align: center;
            word-break: break-all;
        }

        .locker-price {
            background: var(--primary-color);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 1rem;
        }

        .locker-status {
            color: #666;
            font-size: 1.1rem;
        }

        .modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: flex-start;
            padding-top: 20px;
            opacity: 1;
            transition: opacity 0.2s;
            overflow-y: auto;
        }

        .modal.hidden {
            display: none;
            opacity: 0;
            pointer-events: none;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            width: 95%;
            max-width: 400px;
            position: relative;
            margin-bottom: 20px;
        }

        .modal-content.large-modal {
            max-width: 500px;
        }

        .close-modal {
            position: absolute;
            top: 12px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }

        h2 {
            margin-top: 0;
            color: var(--primary-dark);
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            font-size: 1.2rem;
        }

        .action-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 1.15rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            font-family: inherit;
            touch-action: manipulation;
        }

        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .action-btn.primary {
            background: var(--secondary-color);
            color: #fff;
        }

        .action-btn.success {
            background: var(--primary-color);
            color: #fff;
        }

        .action-btn.warning {
            background: var(--accent-color);
            color: #333;
        }

        .action-btn.danger {
            background: var(--danger-color);
            color: #fff;
        }

        .price-display {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-dark);
            text-align: center;
            margin: 10px 0;
        }

        .selected-price {
            text-align: center;
            font-size: 1.1rem;
            margin: 10px 0;
        }

        .selected-price span {
            font-weight: bold;
            color: var(--primary-dark);
            font-size: 1.3rem;
        }

        .price-button-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 10px 0;
        }

        .price-btn {
            padding: 15px 10px;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            background: white;
            color: var(--primary-color);
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s;
        }

        .price-btn:active,
        .price-btn.selected {
            background: var(--primary-color);
            color: white;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 10px 0;
        }

        .preset-btn {
            padding: 12px 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.95rem;
            transition: background 0.2s;
        }

        .preset-btn:active {
            background: #f0f0f0;
        }

        .preset-btn.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .custom-input-area input,
        .add-preset-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
            margin-top: 8px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-btn {
            padding: 8px 10px;
            border: none;
            background: none;
            cursor: pointer;
            font-family: inherit;
            opacity: 0.6;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            font-size: 0.9rem;
        }

        .tab-btn.active {
            opacity: 1;
            border-bottom-color: var(--primary-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .machine-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .sales-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .sales-controls select {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-family: inherit;
        }

        .sales-list-container {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            -webkit-overflow-scrolling: touch;
        }

        #sales-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        #sales-table th,
        #sales-table td {
            padding: 8px 6px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        #sales-table th {
            background: #f9f9f9;
        }

        .delete-record-btn {
            background: #ffebee;
            color: var(--danger-color);
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .preset-list-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }

        .remove-preset-btn {
            color: var(--danger-color);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
        }

        .hidden {
            display: none !important;
        }

        .copy-mode-indicator {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .copy-mode-indicator span {
            flex: 1;
        }

        .cancel-copy-btn {
            background: #fff;
            border: 1px solid #2196F3;
            color: #2196F3;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
        }

        .locker.copy-target {
            border: 3px dashed #2196F3 !important;
            animation: pulse-border 1s infinite;
        }

        @keyframes pulse-border {

            0%,
            100% {
                border-color: #2196F3;
            }

            50% {
                border-color: #90CAF9;
            }
        }

        /* Machine Settings & General Settings */
        .setting-item {
            padding: 15px 0;
        }

        .setting-desc {
            font-size: 0.85rem;
            color: #666;
            margin-top: 8px;
        }

        hr {
            border: none;
            border-top: 1px solid #eee;
        }

        .text-danger {
            color: var(--danger-color);
            font-size: 0.9rem;
            font-weight: bold;
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
        }

        .toggle-container input {
            display: none;
        }

        .checkmark {
            position: relative;
            width: 50px;
            height: 26px;
            background-color: #ccc;
            border-radius: 13px;
            transition: background-color 0.2s;
        }

        .checkmark::after {
            content: "";
            position: absolute;
            width: 22px;
            height: 22px;
            background-color: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }

        input:checked+.checkmark {
            background-color: var(--primary-color);
        }

        input:checked+.checkmark::after {
            transform: translateX(24px);
        }

        .cloud-setting {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .cloud-setting input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .cloud-setting .action-btn {
            width: auto;
            margin: 0;
            padding: 10px 15px;
        }

        /* Undo Notification */
        .undo-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-size: 0.95rem;
        }

        .undo-notification button {
            background: var(--accent-color);
            border: none;
            color: #333;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
        }

        @media (max-width: 400px) {
            .locker-product {
                font-size: 0.85rem;
            }

            .locker-price {
                font-size: 0.75rem;
            }

            .price-btn {
                padding: 12px 8px;
                font-size: 1rem;
            }

            .preset-btn {
                padding: 10px 6px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>

<body>
    <div id="orientation-warning">
        <div class="icon">ğŸ“±</div>
        <p>ç”»é¢ã‚’ç¸¦å‘ãã«ã—ã¦<br>ã”åˆ©ç”¨ãã ã•ã„</p>
    </div>
    <div id="app">
        <header class="app-header">
            <div id="activity-warning" class="activity-warning hidden">âš ï¸ ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ“ä½œä¸­ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“</div>
            <h1>è‡ªå‹•è²©å£²æ©Ÿç®¡ç†</h1>
            <div class="mode-switch">
                <button id="mode-seller" class="mode-btn active">è²©å£²è€…</button>
                <button id="mode-buyer" class="mode-btn">è³¼å…¥è€…</button>
            </div>
            <div id="machine-switch" class="machine-switch">
            </div>
            <button id="menu-btn" class="icon-btn" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">âš™ï¸</button>
        </header>

        <main class="vending-machine">
            <div id="sales-summary" class="sales-summary hidden">
                <div class="sales-summary-item">
                    <span class="sales-label">å‰æ—¥</span>
                    <span id="yesterday-sales" class="sales-amount">Â¥0</span>
                </div>
                <div class="sales-summary-item">
                    <span class="sales-label">ä»Šæ—¥</span>
                    <span id="today-sales" class="sales-amount">Â¥0</span>
                </div>
            </div>
            <div id="bulk-purchase-area" class="bulk-purchase-area hidden">
                <button id="bulk-purchase-btn" class="action-btn warning">ã“ã®è‡ªè²©æ©Ÿã®å•†å“ã‚’ä¸€æ‹¬è³¼å…¥</button>
            </div>
            <div id="copy-mode-indicator" class="copy-mode-indicator hidden">
                <span>ğŸ“‹ ã‚³ãƒ”ãƒ¼ä¸­: <strong id="copy-product-info"></strong></span>
                <button id="cancel-copy-btn" class="cancel-copy-btn">å®Œäº†</button>
            </div>
            <div id="locker-grid" class="locker-grid">
            </div>
        </main>

        <div id="buyer-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2 id="buyer-product-name">å•†å“å</h2>
                <p id="buyer-product-price" class="price-display">Â¥0</p>
                <div class="coin-slot-area">
                    <p>æŠ•å…¥é‡‘é¡: <span id="inserted-amount">0</span>å††</p>
                    <button id="insert-coin-btn" class="action-btn primary">100å††æŠ•å…¥</button>
                </div>
                <button id="unlock-btn" class="action-btn success" disabled>è§£éŒ ã—ã¦å–ã‚Šå‡ºã™</button>
            </div>
        </div>

        <div id="seller-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>å•†å“ç™»éŒ²</h2>
                <div class="preset-area">
                    <p>å•†å“åã‚’é¸æŠ:</p>
                    <div id="preset-buttons" class="preset-grid">
                    </div>
                    <div class="custom-input-area">
                        <input type="text" id="custom-product-name" placeholder="ç›´æ¥å…¥åŠ›ã‚‚å¯èƒ½">
                    </div>
                </div>
                <div class="price-setting-area">
                    <p>ä¾¡æ ¼è¨­å®š:</p>
                    <div id="price-buttons" class="price-button-grid">
                    </div>
                    <p class="selected-price">é¸æŠä¸­: <span id="setting-price">Â¥100</span></p>
                </div>
                <div class="seller-actions">
                    <button id="register-btn" class="action-btn success">ç™»éŒ²ã—ã¦æ–½éŒ </button>
                    <button id="copy-product-btn" class="action-btn primary hidden">ã“ã®å•†å“ã‚’ã‚³ãƒ”ãƒ¼</button>
                    <button id="admin-purchase-btn" class="action-btn warning hidden">ç®¡ç†è€…è³¼å…¥ (ç¡¬è²¨ä¸è¦)</button>
                    <button id="clear-locker-btn" class="action-btn danger hidden">å–ä¸‹ã’ (å£²ä¸Šãªã—)</button>
                </div>
            </div>
        </div>

        <div id="admin-modal" class="modal hidden">
            <div class="modal-content large-modal">
                <span class="close-modal">&times;</span>
                <h2>ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>

                <div class="tabs">
                    <button class="tab-btn active" data-tab="sales">å£²ä¸Šç®¡ç†</button>
                    <button class="tab-btn" data-tab="machines">è‡ªè²©æ©Ÿè¨­å®š</button>
                    <button class="tab-btn" data-tab="presets">ãƒ—ãƒªã‚»ãƒƒãƒˆ</button>
                    <button class="tab-btn" data-tab="data">ãƒ‡ãƒ¼ã‚¿</button>
                </div>

                <div id="tab-sales" class="tab-content active">
                    <div class="sales-controls">
                        <select id="sales-period">
                            <option value="daily">æ—¥åˆ¥</option>
                            <option value="monthly">æœˆåˆ¥</option>
                        </select>
                        <span id="total-sales">åˆè¨ˆ: Â¥0</span>
                    </div>
                    <div class="sales-list-container">
                        <table id="sales-table">
                            <thead>
                                <tr>
                                    <th>æ—¥æ™‚</th>
                                    <th>å•†å“</th>
                                    <th>é‡‘é¡</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="sales-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-machines" class="tab-content">
                    <div class="setting-item">
                        <label class="toggle-container">
                            <span>ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯è³¼å…¥ãƒ¢ãƒ¼ãƒ‰</span>
                            <input type="checkbox" id="one-click-toggle">
                            <span class="checkmark"></span>
                        </label>
                        <p class="setting-desc">è³¼å…¥æ™‚ã«æŠ•å…¥é‡‘é¡ã®æ“ä½œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€ã‚¿ãƒƒãƒ—ã§ã™ãã«ã‚«ã‚®ã‚’é–‹ã‘ã¾ã™ã€‚</p>
                    </div>
                    <hr>
                    <div class="setting-item">
                        <p>ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼ˆGoogleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼‰</p>
                        <div class="cloud-sync-controls" style="margin-bottom: 15px;">
                            <label class="toggle-container">
                                <span>è‡ªå‹•åŒæœŸã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
                                <input type="checkbox" id="auto-sync-toggle">
                                <span class="checkmark"></span>
                            </label>
                            <button id="manual-sync-btn" class="action-btn success"
                                style="margin-top: 10px; width: 100%;">ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</button>
                        </div>
                        <div id="cloud-url-display-area" class="cloud-setting">
                            <input type="password" id="cloud-url-input" placeholder="GAS Webã‚¢ãƒ—ãƒªã®URL" readonly>
                            <button id="edit-cloud-url-btn" class="action-btn primary">ç·¨é›†</button>
                        </div>
                        <div id="cloud-url-edit-area" class="cloud-setting hidden">
                            <input type="text" id="cloud-url-edit-input" placeholder="URLã‚’è²¼ã‚Šä»˜ã‘">
                            <button id="save-cloud-url-btn" class="action-btn success">ä¿å­˜</button>
                        </div>
                        <p class="setting-desc">URLã‚’è¨­å®šã™ã‚‹ã¨ã€è¤‡æ•°ç«¯æœ«ã§åœ¨åº«ã‚„å£²ä¸ŠãŒå…±æœ‰ã•ã‚Œã¾ã™ã€‚</p>
                    </div>
                    <hr>
                    <div class="setting-item">
                        <p>ç¾åœ¨ã®è‡ªè²©æ©Ÿå°æ•°: <strong id="machine-count">2</strong>å°</p>
                        <div class="machine-actions">
                            <button id="add-machine-btn" class="action-btn primary">è‡ªè²©æ©Ÿã‚’è¿½åŠ </button>
                            <button id="remove-machine-btn" class="action-btn danger">æœ€å¾Œã®è‡ªè²©æ©Ÿã‚’å‰Šé™¤</button>
                        </div>
                    </div>
                </div>

                <div id="tab-presets" class="tab-content">
                    <div id="edit-preset-list" class="preset-list">
                    </div>
                    <div class="add-preset-form">
                        <input type="text" id="new-preset-name" placeholder="æ–°ã—ã„é‡èœå">
                        <button id="add-preset-btn" class="action-btn">è¿½åŠ </button>
                    </div>
                </div>

                <div id="tab-data" class="tab-content">
                    <div class="setting-item">
                        <p>ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ãƒ»å¾©å…ƒã§ãã¾ã™ã€‚</p>
                        <div class="data-actions">
                            <button id="download-data-btn" class="action-btn primary">ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                            <div class="upload-area">
                                <input type="file" id="upload-data-input" accept=".json">
                                <button id="upload-data-btn" class="action-btn warning">ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿</button>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="setting-item">
                        <p><strong>ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã®è¨­å®šæ–¹æ³•:</strong><br>
                            1. Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã€æ‹¡å¼µæ©Ÿèƒ½ã®Apps Scriptã«å°‚ç”¨ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚<br>
                            2. Webã‚¢ãƒ—ãƒªã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€ç™ºè¡Œã•ã‚ŒãŸURLã‚’ã€Œè‡ªè²©æ©Ÿè¨­å®šã€ã‚¿ãƒ–ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
                            â€»è©³ç´°ã¯ <code>GAS_INSTRUCTIONS.md</code> ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                    <hr>
                    <div class="setting-item">
                        <p class="text-danger">âš ï¸ å£²ä¸Šå±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ï¼ˆåœ¨åº«ã¯ç¶­æŒã•ã‚Œã¾ã™ï¼‰ã€‚</p>
                        <button id="clear-all-sales-btn" class="action-btn danger">å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const STORAGE_KEY = 'vending_machine_data';
        const DEFAULT_PRESETS = ['å¤§ç‰ãƒˆãƒãƒˆ', 'ä¸­ç‰ãƒˆãƒãƒˆ', 'ãƒŸãƒ‹ãƒˆãƒãƒˆ', 'ãƒ¬ã‚¿ã‚¹', 'ã„ã¡ã”', 'ã‚­ãƒ¥ã‚¦ãƒª'];
        const TOTAL_ROWS = 6;
        const TOTAL_COLS = 3;
        const PRICE_OPTIONS = [100, 200, 300, 400, 500, 600, 700, 800, 900];

        // çŠ¶æ…‹ç®¡ç†
        let state = {
            data: {
                lockers: [],
                sales: [],
                presets: [...DEFAULT_PRESETS],
                machineCount: 2,
                cloudUrl: '', // ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸURL
                autoSync: true
            },
            currentMachine: 1,
            mode: 'seller',
            selectedLockerId: null,
            tempPrice: 100,
            tempAmount: 0,
            copyMode: false,
            copyProduct: null,
            oneClickMode: false,
            lastPurchase: null,
            isSyncing: false,       // é€ä¿¡ä¸­ãƒ•ãƒ©ã‚°
            lastLocalEditTime: 0    // æœ€çµ‚æ“ä½œæ™‚åˆ»
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initLockers();
            renderApp();
            setupEventListeners();

            // ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šãŒã‚ã‚Œã°åˆå›åŒæœŸ
            if (state.data.cloudUrl) {
                fetchFromCloud();
            }

            // å®šæœŸåŒæœŸè¨­å®š (30ç§’ã”ã¨)
            setInterval(() => {
                const isModalOpen = Array.from(document.querySelectorAll('.modal')).some(m => !m.classList.contains('hidden'));

                if (state.data.cloudUrl && state.data.autoSync && !state.copyMode && !isModalOpen) {
                    fetchFromCloud(true);
                }
            }, 30000);

            // ç”»é¢ã®å‘ãã‚’ç¸¦ã«ãƒ­ãƒƒã‚¯
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('portrait').catch(err => {
                    console.log('Orientation lock failed:', err);
                });
            }
        });

        function loadData() {
            const json = localStorage.getItem(STORAGE_KEY);
            if (json) {
                try {
                    const parsed = JSON.parse(json);
                    state.data = { ...state.data, ...parsed };
                    if (state.data.autoSync === undefined) state.data.autoSync = true;
                    if (!state.data.presets) state.data.presets = [...DEFAULT_PRESETS];
                    if (!state.data.machineCount) state.data.machineCount = 2;
                } catch (e) {
                    console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', e);
                }
            }
        }

        function saveData() {
            state.lastLocalEditTime = Date.now(); // æ“ä½œæ™‚åˆ»ã‚’è¨˜éŒ²
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
            if (state.data.cloudUrl) {
                pushToCloud();
            }
        }

        function initLockers() {
            const isOrderCorrect = state.data.lockers.length > 0 &&
                state.data.lockers[0].col === 3 &&
                state.data.lockers[0].row === 1;

            if (state.data.lockers.length === 0 || !state.data.lockers[0].coordNum || !isOrderCorrect) {
                if (state.data.lockers.length > 0) {
                    sortLockersCorrectly();
                } else {
                    state.data.lockers = [];
                    for (let m = 1; m <= state.data.machineCount; m++) {
                        createLockers(m);
                    }
                }
            } else {
                const existingMachineIds = new Set(state.data.lockers.map(l => l.machineId));
                for (let m = 1; m <= state.data.machineCount; m++) {
                    if (!existingMachineIds.has(m)) createLockers(m);
                }
            }
            saveDataLocally();
        }

        function sortLockersCorrectly() {
            state.data.lockers.sort((a, b) => {
                if (a.machineId !== b.machineId) return a.machineId - b.machineId;
                if (a.row !== b.row) return a.row - b.row;
                return b.col - a.col;
            });
        }

        function createLockers(m) {
            // å³ä¸ŠãŒ1-1ã«ãªã‚‹ã‚ˆã†ã€[3åˆ—, 2åˆ—, 1åˆ—]ã®é †ã§ç”Ÿæˆã™ã‚‹
            for (let r = 1; r <= TOTAL_ROWS; r++) {
                for (let c = 3; c >= 1; c--) {
                    state.data.lockers.push({
                        id: `${m}-${r}-${c}`,
                        machineId: m, machineNum: m,
                        row: r, col: c,
                        coordNum: `${c}-${r}`,
                        isLocked: false, productName: '', price: 0, insertedAmount: 0
                    });
                }
            }
        }

        function renderApp() {
            renderHeader();
            renderMachineTabs();
            renderLockers();
            renderBulkPurchaseArea();
            renderSalesSummary();
            renderCopyModeIndicator();
            renderAdminSales();
            renderAdminPresets();
            renderMachineSettings();
            renderDataSettings();
        }

        function renderHeader() {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(state.mode === 'buyer' ? 'mode-buyer' : 'mode-seller').classList.add('active');
        }

        function renderMachineTabs() {
            const container = document.getElementById('machine-switch');
            container.innerHTML = '';
            for (let m = 1; m <= state.data.machineCount; m++) {
                const btn = document.createElement('button');
                btn.className = `machine-tab ${m === state.currentMachine ? 'active' : ''}`;
                btn.dataset.machine = m;
                btn.textContent = `è‡ªè²©æ©Ÿ${m}`;
                btn.onclick = () => {
                    state.currentMachine = m;
                    renderApp();
                };
                container.appendChild(btn);
            }
        }

        function renderLockers() {
            const grid = document.getElementById('locker-grid');
            grid.innerHTML = '';
            const targetLockers = state.data.lockers.filter(l => l.machineId === state.currentMachine);
            targetLockers.forEach(locker => {
                const el = document.createElement('div');
                let classes = 'locker';
                if (locker.isLocked) classes += ' locked';
                if (state.copyMode && !locker.isLocked) classes += ' copy-target';
                el.className = classes;
                el.dataset.id = locker.id;
                el.onclick = () => handleLockerClick(locker);

                const idSpan = document.createElement('span');
                idSpan.className = 'locker-id';
                idSpan.textContent = locker.coordNum;

                const contentDiv = document.createElement('div');
                contentDiv.style.textAlign = 'center';
                contentDiv.style.width = '100%';

                if (locker.isLocked) {
                    contentDiv.innerHTML = `
                        <div class="locker-product">${escapeHtml(locker.productName)}</div>
                        <div class="locker-price">Â¥${locker.price}</div>
                    `;
                } else {
                    contentDiv.innerHTML = `<span class="locker-status">ç©ºã</span>`;
                }

                el.append(idSpan, contentDiv);
                grid.appendChild(el);
            });
        }

        function renderBulkPurchaseArea() {
            const area = document.getElementById('bulk-purchase-area');
            const btn = document.getElementById('bulk-purchase-btn');
            if (state.mode === 'seller') {
                const hasProducts = state.data.lockers.some(l => l.machineId === state.currentMachine && l.isLocked);
                if (hasProducts) {
                    area.classList.remove('hidden');
                    // ã‚³ãƒ”ãƒ¼ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ç„¡åŠ¹åŒ–
                    btn.disabled = state.copyMode;
                } else {
                    area.classList.add('hidden');
                }
            } else {
                area.classList.add('hidden');
            }
        }

        function renderSalesSummary() {
            const summary = document.getElementById('sales-summary');
            const yesterdayEl = document.getElementById('yesterday-sales');
            const todayEl = document.getElementById('today-sales');

            if (state.mode === 'seller') {
                summary.classList.remove('hidden');
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);

                let todayTotal = 0;
                let yesterdayTotal = 0;

                state.data.sales.forEach(sale => {
                    const saleDate = new Date(sale.date);
                    const saleDateOnly = new Date(saleDate.getFullYear(), saleDate.getMonth(), saleDate.getDate());
                    if (saleDateOnly.getTime() === today.getTime()) {
                        todayTotal += sale.price;
                    } else if (saleDateOnly.getTime() === yesterday.getTime()) {
                        yesterdayTotal += sale.price;
                    }
                });

                yesterdayEl.textContent = `Â¥${yesterdayTotal.toLocaleString()}`;
                todayEl.textContent = `Â¥${todayTotal.toLocaleString()}`;
            } else {
                summary.classList.add('hidden');
            }
        }

        function setupEventListeners() {
            document.getElementById('mode-buyer').onclick = () => setMode('buyer');
            document.getElementById('mode-seller').onclick = () => setMode('seller');
            document.getElementById('menu-btn').onclick = () => openModal('admin-modal');

            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.onclick = () => closeModal();
            });

            window.onclick = (event) => {
                if (event.target.classList.contains('modal')) {
                    closeModal();
                }
            };

            document.getElementById('insert-coin-btn').onclick = () => {
                state.tempAmount += 100;
                updateBuyerModalUI();
            };
            document.getElementById('unlock-btn').onclick = processPurchase;

            document.getElementById('register-btn').onclick = registerProduct;
            document.getElementById('admin-purchase-btn').onclick = processAdminPurchase;
            document.getElementById('clear-locker-btn').onclick = clearLocker;
            document.getElementById('copy-product-btn').onclick = startCopyMode;
            document.getElementById('cancel-copy-btn').onclick = cancelCopyMode;
            document.getElementById('bulk-purchase-btn').onclick = processBulkPurchase;

            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
                };
            });

            document.getElementById('add-preset-btn').onclick = addPreset;
            document.getElementById('add-machine-btn').onclick = addMachine;
            document.getElementById('remove-machine-btn').onclick = removeMachine;
            document.getElementById('download-data-btn').onclick = downloadData;
            document.getElementById('upload-data-btn').onclick = () => document.getElementById('upload-data-input').click();
            document.getElementById('upload-data-input').onchange = uploadData;
            document.getElementById('sales-period').onchange = renderAdminSales;
        }

        function setMode(mode) {
            state.mode = mode;
            renderApp();
        }

        function handleLockerClick(locker) {
            state.selectedLockerId = locker.id;
            if (state.copyMode) {
                if (!locker.isLocked) {
                    // ç©ºããƒ­ãƒƒã‚«ãƒ¼ã«ã‚³ãƒ”ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘
                    pasteProduct(locker);
                } else {
                    // ã‚³ãƒ”ãƒ¼ã—ãŸï¼ˆåŒã˜å†…å®¹ã®ï¼‰å•†å“ã‚’ã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã§ç©ºãã«æˆ»ã™
                    if (state.copyProduct &&
                        locker.productName === state.copyProduct.productName &&
                        locker.price === state.copyProduct.price) {

                        updateLocker(locker.id, {
                            isLocked: false,
                            productName: '',
                            price: 0,
                            insertedAmount: 0
                        });
                        saveData();
                        renderApp();
                    }
                }
                return;
            }
            if (state.mode === 'seller') {
                openSellerModal(locker);
            } else {
                if (locker.isLocked) {
                    if (state.oneClickMode) {
                        processQuickPurchase(locker);
                    } else {
                        openBuyerModal(locker);
                    }
                }
            }
        }

        function openSellerModal(locker) {
            const productNameInput = document.getElementById('custom-product-name');
            const adminPurchaseBtn = document.getElementById('admin-purchase-btn');
            const clearBtn = document.getElementById('clear-locker-btn');
            const registerBtn = document.getElementById('register-btn');
            const copyBtn = document.getElementById('copy-product-btn');

            renderPresetButtons();
            renderPriceButtons();

            if (locker.isLocked) {
                productNameInput.value = locker.productName;
                state.tempPrice = locker.price;
                adminPurchaseBtn.classList.remove('hidden');
                clearBtn.classList.remove('hidden');
                copyBtn.classList.remove('hidden');
                registerBtn.textContent = "æ›´æ–°";
            } else {
                productNameInput.value = '';
                state.tempPrice = 100;
                adminPurchaseBtn.classList.add('hidden');
                clearBtn.classList.add('hidden');
                copyBtn.classList.add('hidden');
                registerBtn.textContent = "ç™»éŒ²ã—ã¦æ–½éŒ ";
            }

            updatePriceDisplay();
            updatePriceButtonSelection();
            openModal('seller-modal');
        }

        function renderCopyModeIndicator() {
            const indicator = document.getElementById('copy-mode-indicator');
            const productInfo = document.getElementById('copy-product-info');
            if (state.copyMode && state.copyProduct) {
                indicator.classList.remove('hidden');
                productInfo.textContent = `${state.copyProduct.productName} Â¥${state.copyProduct.price}`;
            } else {
                indicator.classList.add('hidden');
            }
        }

        function startCopyMode() {
            const locker = state.data.lockers.find(l => l.id === state.selectedLockerId);
            if (!locker || !locker.isLocked) return;
            state.copyMode = true;
            state.copyProduct = {
                productName: locker.productName,
                price: locker.price
            };
            closeModal();
            renderApp();
        }

        function cancelCopyMode() {
            state.copyMode = false;
            state.copyProduct = null;
            renderApp();
        }

        function pasteProduct(locker) {
            if (!state.copyProduct) return;
            updateLocker(locker.id, {
                isLocked: true,
                productName: state.copyProduct.productName,
                price: state.copyProduct.price,
                insertedAmount: 0
            });
            saveData();
            renderApp();
        }

        function renderPresetButtons() {
            const container = document.getElementById('preset-buttons');
            container.innerHTML = '';
            state.data.presets.forEach(p => {
                const btn = document.createElement('button');
                btn.textContent = p;
                btn.className = 'preset-btn';
                btn.onclick = () => {
                    document.getElementById('custom-product-name').value = p;
                    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                };
                container.appendChild(btn);
            });
        }

        function renderPriceButtons() {
            const container = document.getElementById('price-buttons');
            container.innerHTML = '';
            PRICE_OPTIONS.forEach(price => {
                const btn = document.createElement('button');
                btn.textContent = `Â¥${price}`;
                btn.className = 'price-btn';
                btn.dataset.price = price;
                btn.onclick = () => {
                    state.tempPrice = price;
                    updatePriceDisplay();
                    updatePriceButtonSelection();
                };
                container.appendChild(btn);
            });
        }

        function updatePriceButtonSelection() {
            document.querySelectorAll('.price-btn').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.dataset.price) === state.tempPrice);
            });
        }

        function updatePriceDisplay() {
            document.getElementById('setting-price').textContent = `Â¥${state.tempPrice}`;
        }

        function registerProduct() {
            const name = document.getElementById('custom-product-name').value;
            if (!name) {
                alert('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (state.tempPrice <= 0) {
                alert('ä¾¡æ ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            updateLocker(state.selectedLockerId, {
                isLocked: true,
                productName: name,
                price: state.tempPrice,
                insertedAmount: 0
            });
            saveData();
            closeModal();
            renderApp();
        }

        function clearLocker() {
            if (!confirm('æœ¬å½“ã«å–ã‚Šä¸‹ã’ã¾ã™ã‹ï¼Ÿï¼ˆå£²ä¸Šã«ã¯è¨ˆä¸Šã•ã‚Œã¾ã›ã‚“ï¼‰')) return;
            updateLocker(state.selectedLockerId, {
                isLocked: false,
                productName: '',
                price: 0,
                insertedAmount: 0
            });
            saveData();
            closeModal();
            renderApp();
        }

        function processAdminPurchase() {
            const locker = state.data.lockers.find(l => l.id === state.selectedLockerId);
            if (!locker) return;
            addSalesRecord(locker.productName, locker.price, locker.machineId);
            updateLocker(state.selectedLockerId, {
                isLocked: false,
                productName: '',
                price: 0,
                insertedAmount: 0
            });
            saveData();
            closeModal();
            renderApp();
            alert('ç¡¬è²¨ä¸è¦ã§è³¼å…¥å‡¦ç†ã—ã¾ã—ãŸï¼ˆå£²ä¸Šã«è¨ˆä¸Šã•ã‚Œã¾ã—ãŸï¼‰');
        }

        function processBulkPurchase() {
            const machineLockers = state.data.lockers.filter(l => l.machineId === state.currentMachine && l.isLocked);
            if (machineLockers.length === 0) {
                alert('ã“ã®è‡ªè²©æ©Ÿã«ã¯å•†å“ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            const totalAmount = machineLockers.reduce((sum, l) => sum + l.price, 0);
            const productCount = machineLockers.length;
            if (!confirm(`è‡ªè²©æ©Ÿ${state.currentMachine}ã®å•†å“ã‚’ä¸€æ‹¬è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ\n\nå•†å“æ•°: ${productCount}å€‹\nåˆè¨ˆé‡‘é¡: Â¥${totalAmount}\n\nâ€»ã™ã¹ã¦ã®å•†å“ãŒå£²ä¸Šã«è¨ˆä¸Šã•ã‚Œã€ãƒ­ãƒƒã‚«ãƒ¼ã¯ç©ºã«ãªã‚Šã¾ã™ã€‚`)) {
                return;
            }
            machineLockers.forEach(locker => {
                addSalesRecord(locker.productName, locker.price, locker.machineId, null, locker.machineNum, locker.coordNum);
                updateLocker(locker.id, {
                    isLocked: false,
                    productName: '',
                    price: 0,
                    insertedAmount: 0
                });
            });
            saveData();
            renderApp();
            alert(`ä¸€æ‹¬è³¼å…¥ãŒå®Œäº†ã—ã¾ã—ãŸ\n\nå£²ä¸Š: Â¥${totalAmount}`);
        }

        function openBuyerModal(locker) {
            state.tempAmount = 0;
            document.getElementById('buyer-product-name').textContent = locker.productName;
            document.getElementById('buyer-product-price').textContent = `Â¥${locker.price}`;
            updateBuyerModalUI(locker);
            openModal('buyer-modal');
        }

        function updateBuyerModalUI(locker = null) {
            if (!locker) {
                locker = state.data.lockers.find(l => l.id === state.selectedLockerId);
            }
            document.getElementById('inserted-amount').textContent = state.tempAmount;
            const unlockBtn = document.getElementById('unlock-btn');
            if (state.tempAmount >= locker.price) {
                unlockBtn.disabled = false;
                unlockBtn.textContent = "è§£éŒ ã—ã¦å–ã‚Šå‡ºã™";
            } else {
                unlockBtn.disabled = true;
                unlockBtn.textContent = `ã‚ã¨${locker.price - state.tempAmount}å††ä¸è¶³`;
            }
        }

        function processPurchase() {
            const locker = state.data.lockers.find(l => l.id === state.selectedLockerId);
            if (!locker) return;
            addSalesRecord(locker.productName, locker.price, locker.machineId, null, locker.machineNum, locker.coordNum);
            updateLocker(state.selectedLockerId, {
                isLocked: false,
                productName: '',
                price: 0,
                insertedAmount: 0
            });
            saveData();
            closeModal();
            renderApp();
            alert('ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼å•†å“ã‚’ãŠå–ã‚Šãã ã•ã„ã€‚');
        }

        // -- ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯è³¼å…¥ (Quick Purchase) --

        function processQuickPurchase(locker) {
            const saleId = Date.now() + Math.random();
            addSalesRecord(locker.productName, locker.price, locker.machineId, saleId, locker.machineNum, locker.coordNum);

            // ãƒ­ãƒƒã‚«ãƒ¼ã‚’ç©ºã«ã™ã‚‹
            updateLocker(locker.id, {
                isLocked: false,
                productName: '',
                price: 0,
                insertedAmount: 0
            });

            // Undoç”¨ã«è¨˜éŒ²
            state.lastPurchase = {
                lockerId: locker.id,
                saleId: saleId,
                productName: locker.productName,
                price: locker.price,
                machineId: locker.machineId
            };

            saveData();
            renderApp();
            showUndoNotification();
        }

        function showUndoNotification() {
            const existing = document.getElementById('undo-notification');
            if (existing) existing.remove();

            const el = document.createElement('div');
            el.id = 'undo-notification';
            el.className = 'undo-notification';
            el.innerHTML = `
                <span>è³¼å…¥ã—ã¾ã—ãŸ</span>
                <button onclick="undoPurchase()">å…ƒã«æˆ»ã™</button>
            `;
            document.body.appendChild(el);

            // 5ç§’å¾Œã«æ¶ˆã™
            setTimeout(() => {
                if (el.parentNode) el.remove();
            }, 5000);
        }

        window.undoPurchase = function () {
            if (!state.lastPurchase) return;

            const lp = state.lastPurchase;
            // å£²ä¸Šè¨˜éŒ²ã‚’å‰Šé™¤
            state.data.sales = state.data.sales.filter(s => s.id !== lp.saleId);

            // ãƒ­ãƒƒã‚«ãƒ¼ã‚’å¾©å…ƒ
            updateLocker(lp.lockerId, {
                isLocked: true,
                productName: lp.productName,
                price: lp.price,
                insertedAmount: 0
            });

            state.lastPurchase = null;
            const el = document.getElementById('undo-notification');
            if (el) el.remove();

            saveData();
            renderApp();
            alert('è³¼å…¥ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ');
        };


        // -- ã‚¯ãƒ©ã‚¦ãƒ‰é€šä¿¡ãƒ­ã‚¸ãƒƒã‚¯ --

        async function fetchFromCloud(silent = false) {
            if (!state.data.cloudUrl) return;

            // æ“ä½œä¸­ã€ã¾ãŸã¯æ“ä½œç›´å¾Œï¼ˆ5ç§’ä»¥å†…ï¼‰ã¯èª­ã¿è¾¼ã¾ãªã„
            if (state.isSyncing) return;
            if (Date.now() - state.lastLocalEditTime < 5000) return;

            if (!silent) console.log('Fetching from cloud...');
            try {
                state.isSyncing = true;
                const response = await fetch(state.data.cloudUrl, { cache: 'no-store' });
                const cloudData = await response.json();

                // å—ä¿¡ä¸­ã«ã‚‚ã—æ“ä½œãŒã‚ã£ãŸã‚‰ç ´æ£„
                if (Date.now() - state.lastLocalEditTime < 3000) {
                    state.isSyncing = false;
                    return;
                }
                if (cloudData && cloudData.lockers) {
                    // ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ç¢ºèª
                    if (cloudData.lastActiveTime) {
                        const diff = Date.now() - cloudData.lastActiveTime;
                        state.otherUserActive = diff < 60000;
                        const warningEl = document.getElementById('activity-warning');
                        if (warningEl) warningEl.classList.toggle('hidden', !state.otherUserActive);
                    }

                    // è¨­å®šã®åŒæœŸ
                    if (cloudData.oneClickMode !== undefined) {
                        state.oneClickMode = (cloudData.oneClickMode === true || cloudData.oneClickMode === "true");
                    }

                    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã®ã‚‚ã®ã§æ›´æ–°ï¼ˆæ—¥ä»˜åŒ–å¯¾ç­– & ã‚½ãƒ¼ãƒˆï¼‰
                    state.data.lockers = (cloudData.lockers || []).map(l => {
                        if (!(l.coordNum && typeof l.coordNum === 'string' && l.coordNum.includes('-'))) {
                            if (l.row && l.col) l.coordNum = `${l.col}-${l.row}`;
                        }
                        l.machineId = parseInt(l.machineId);
                        l.row = parseInt(l.row);
                        l.col = parseInt(l.col);
                        return l;
                    });
                    sortLockersCorrectly();

                    state.data.sales = cloudData.sales || [];
                    state.data.presets = cloudData.presets || state.data.presets;
                    state.data.machineCount = parseInt(cloudData.machineCount) || state.data.machineCount;

                    initLockers();
                    saveDataLocally();
                    renderApp();
                    if (!silent) console.log('Cloud sync complete');
                }
            } catch (err) {
                console.error('Cloud fetch error:', err);
                if (!silent) alert('ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            } finally {
                state.isSyncing = false;
            }
        }

        async function pushToCloud() {
            if (!state.data.cloudUrl) return;
            state.isSyncing = true;
            const payload = {
                lockers: state.data.lockers,
                sales: state.data.sales,
                presets: state.data.presets,
                machineCount: state.data.machineCount,
                oneClickMode: state.oneClickMode
            };
            try {
                await fetch(state.data.cloudUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                console.log('Pushed to cloud');
            } catch (err) {
                console.error('Cloud push error:', err);
            } finally {
                state.isSyncing = false;
            }
        }

        function saveDataLocally() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
        }

        function updateLocker(id, Updates) {
            const idx = state.data.lockers.findIndex(l => l.id === id);
            if (idx !== -1) {
                state.data.lockers[idx] = { ...state.data.lockers[idx], ...Updates };
            }
        }

        function getJSTDateTime() {
            const now = new Date();
            const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
            return jstNow.toISOString().replace('T', ' ').replace(/\..+/, '');
        }

        function addSalesRecord(name, price, machineId, id = null, machineNum = null, coordNum = null) {
            state.data.sales.push({
                id: id || (Date.now() + Math.random()),
                date: getJSTDateTime(),
                productName: name,
                price: price,
                machineId: machineId,
                machineNum: machineNum,
                coordNum: coordNum
            });
        }

        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden'));
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, function (m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                }[m];
            });
        }

        function renderAdminSales() {
            const tbody = document.getElementById('sales-table-body');
            const totalEl = document.getElementById('total-sales');
            const period = document.getElementById('sales-period').value;
            tbody.innerHTML = '';
            let filtered = [...state.data.sales];
            const now = new Date();

            if (period === 'monthly') {
                filtered = filtered.filter(s => {
                    const d = new Date(s.date);
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
            } else {
                filtered = filtered.filter(s => {
                    const d = new Date(s.date);
                    return d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
            }

            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            let sum = 0;
            filtered.forEach(sale => {
                sum += sale.price;
                const tr = document.createElement('tr');
                const d = new Date(sale.date);
                const dateStr = `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                const locInfo = sale.coordNum ? `<small style="color:#888">[è‡ªè²©æ©Ÿ${sale.machineNum || sale.machineId} ${sale.coordNum}]</small>` : '';
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${escapeHtml(sale.productName)} ${locInfo}</td>
                    <td>Â¥${sale.price}</td>
                    <td><button class="delete-record-btn" onclick="deleteSale(${sale.id})">å‰Šé™¤</button></td>
                `;
                tbody.appendChild(tr);
            });
            totalEl.textContent = `åˆè¨ˆ: Â¥${sum}`;
        }

        window.deleteSale = function (id) {
            if (!confirm('ã“ã®å£²ä¸Šè¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            state.data.sales = state.data.sales.filter(s => String(s.id) !== String(id));
            saveData();
            renderApp();
        };

        function clearAllSales() {
            if (!confirm('ã™ã¹ã¦ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æ¶ˆå»ãªã©ã«ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼‰')) return;
            state.data.sales = [];
            saveData();
            renderApp();
            alert('å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        function renderAdminPresets() {
            const list = document.getElementById('edit-preset-list');
            list.innerHTML = '';
            state.data.presets.forEach((p, index) => {
                const div = document.createElement('div');
                div.className = 'preset-list-item';
                div.innerHTML = `
                    <span>${escapeHtml(p)}</span>
                    <button class="remove-preset-btn" onclick="removePreset(${index})">&times;</button>
                `;
                list.appendChild(div);
            });
        }

        function addPreset() {
            const input = document.getElementById('new-preset-name');
            const val = input.value.trim();
            if (val) {
                state.data.presets.push(val);
                input.value = '';
                saveData();
                renderAdminPresets();
            }
        }

        window.removePreset = function (index) {
            if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            state.data.presets.splice(index, 1);
            saveData();
            renderAdminPresets();
        };

        function renderMachineSettings() {
            document.getElementById('machine-count').textContent = state.data.machineCount;
            document.getElementById('one-click-toggle').checked = state.oneClickMode;
        }

        function renderMachineSettings() {
            document.getElementById('machine-count').textContent = state.data.machineCount;
            document.getElementById('one-click-toggle').checked = state.oneClickMode;
        }

        function renderDataSettings() {
            // ãƒ‡ãƒ¼ã‚¿ç³»ã®UIæ›´æ–°ãŒã‚ã‚Œã°ã“ã“
        }

        function addMachine() {
            state.data.machineCount++;
            const m = state.data.machineCount;
            for (let r = 1; r <= TOTAL_ROWS; r++) {
                for (let c = 1; c <= TOTAL_COLS; c++) {
                    state.data.lockers.push({
                        id: `${m}-${r}-${c}`,
                        machineId: m,
                        row: r,
                        col: c,
                        isLocked: false,
                        productName: '',
                        price: 0,
                        insertedAmount: 0
                    });
                }
            }
            saveData();
            renderApp();
            alert(`è‡ªè²©æ©Ÿ${m}ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
        }

        function removeMachine() {
            if (state.data.machineCount <= 1) {
                alert('æœ€ä½1å°ã¯å¿…è¦ã§ã™');
                return;
            }
            const m = state.data.machineCount;
            const machineLockers = state.data.lockers.filter(l => l.machineId === m);
            const hasProducts = machineLockers.some(l => l.isLocked);

            if (hasProducts) {
                if (!confirm(`è‡ªè²©æ©Ÿ${m}ã«ã¯å•†å“ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚å‰Šé™¤ã™ã‚‹ã¨å•†å“ãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆãˆã¾ã™ãŒã€ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                    return;
                }
            } else {
                if (!confirm(`è‡ªè²©æ©Ÿ${m}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    return;
                }
            }

            state.data.lockers = state.data.lockers.filter(l => l.machineId !== m);
            state.data.machineCount--;

            if (state.currentMachine > state.data.machineCount) {
                state.currentMachine = 1;
            }

            saveData();
            renderApp();
            alert(`è‡ªè²©æ©Ÿ${m}ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }

        function downloadData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.data));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "vending_machine_data.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function uploadData() {
            const input = document.getElementById('upload-data-input');
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (json && json.lockers) {
                        state.data = json;
                        if (!state.data.machineCount) {
                            const maxMachine = Math.max(...state.data.lockers.map(l => l.machineId));
                            state.data.machineCount = maxMachine || 2;
                        }
                        saveData();
                        renderApp();
                        alert('ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ');
                    } else {
                        alert('ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                    }
                } catch (err) {
                    console.error(err);
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                input.value = '';
            };
            reader.readAsText(file);
        }

        // ---------------------------------------------------------
        // ç”»é¢ã®å‘ãåˆ¶å¾¡ (JSå®Ÿè£…)
        // ---------------------------------------------------------
        function initOrientationControl() {
            const warningEl = document.getElementById('orientation-warning');
            if (!warningEl) return;

            const checkOrientation = () => {
                // 1. å…¥åŠ›ä¸­ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºä¸­ï¼‰ã¯è­¦å‘Šã‚’å‡ºã•ãªã„
                const activeTag = document.activeElement ? document.activeElement.tagName : '';
                if (activeTag === 'INPUT' || activeTag === 'TEXTAREA') {
                    warningEl.classList.remove('visible');
                    document.body.style.overflow = '';
                    return;
                }

                // 2. å‘ãã®åˆ¤å®š
                let isLandscape = false;

                // Modern API
                if (screen.orientation && screen.orientation.type) {
                    isLandscape = screen.orientation.type.includes('landscape');
                }
                // iOS / Older WebKit
                else if (typeof window.orientation !== 'undefined') {
                    isLandscape = (Math.abs(window.orientation) === 90);
                }
                // Fallback (ã‚µã‚¤ã‚ºæ¯”)
                else {
                    isLandscape = (window.innerWidth > window.innerHeight);
                }

                // 3. PCï¼ˆå¹…åºƒã‹ã¤é«˜ã•ã‚‚ã‚ã‚‹ï¼‰ã®å ´åˆã¯é™¤å¤–ã—ãŸã„ãŒã€
                // ä»Šå›ã®è¦ä»¶ã¯ã€Œã‚¹ãƒãƒ›ã§æ¨ªã«ã—ãŸã‚‰è­¦å‘Šã€ãªã®ã§ã€
                // ç”»é¢å¹…ãŒãƒ¢ãƒã‚¤ãƒ«ã‚µã‚¤ã‚º(900pxä»¥ä¸‹)ã®å ´åˆã®ã¿è­¦å‘Šã‚’å‡ºã™
                if (window.innerWidth > 900) {
                    isLandscape = false;
                }

                // 4. è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
                if (isLandscape) {
                    warningEl.classList.add('visible');
                    document.body.style.overflow = 'hidden';
                } else {
                    warningEl.classList.remove('visible');
                    document.body.style.overflow = '';
                }
            };

            window.addEventListener('resize', checkOrientation);
            window.addEventListener('orientationchange', checkOrientation);

            document.addEventListener('focusin', () => {
                warningEl.classList.remove('visible');
                document.body.style.overflow = '';
            });

            document.addEventListener('focusout', () => {
                setTimeout(checkOrientation, 300);
            });

            checkOrientation();
        }

        document.addEventListener('DOMContentLoaded', initOrientationControl);
    </script>
</body>

</html>